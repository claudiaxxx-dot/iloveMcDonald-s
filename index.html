<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…¨çƒåœ°å›¾ - åˆå¹¶åŒåœ°ç‚¹å•é’ˆã€å¤šæ ‡ç­¾</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body, #map { height: 100%; width: 100%; margin: 0; }
    #controls { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    #controls input, #controls select, #controls button { margin: 4px 0; }

    /* è‡ªå®šä¹‰å•é’ˆ + å¤šæ ‡ç­¾æ ·å¼ */
    .pin-wrapper { display: inline-flex; align-items: center; gap: 8px; transform: translateY(-12px); font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; }
    .pin-emoji { font-size: 22px; line-height: 1; }
    .labels { display: inline-flex; gap: 6px; flex-wrap: wrap; }
    .chip { font-size: 13px; background: #fff; border: 1px solid rgba(0,0,0,0.12); box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-radius: 999px; padding: 2px 8px; white-space: nowrap; }

    /* æç¤º */
    .hint { position: absolute; right: 10px; bottom: 10px; z-index: 900; background: rgba(255,255,255,0.95); padding: 8px 10px; border-radius: 10px; font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);} 
  </style>
</head>
<body>
  <div id="controls">
    <div><strong>ä¿®æ”¹ä½ç½®</strong></div>
    <label>
      é€‰æ‹©åå­—ï¼š
      <select id="person-select"></select>
    </label>
    <br/>
    <input id="place-input" placeholder="è¾“å…¥æ–°åœ°ç‚¹ï¼Œå¦‚ï¼šæ·±åœ³ / å¹¿å· / Washington DC" size="36" />
    <br/>
    <button id="update-btn">æ›´æ–°åˆ°è¯¥åœ°ç‚¹</button>
  </div>
  <div id="map"></div>
  <div class="hint">åŒä¸€åæ ‡åªæ˜¾ç¤º <b>1 ä¸ªğŸ“Œ</b>ï¼Œä½†ä¼šåŒæ—¶å±•ç¤ºè¯¥åœ°ç‚¹çš„æ‰€æœ‰åå­—ï¼ˆæ ‡ç­¾ï¼‰ã€‚</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ====== 1) åœ°å›¾åˆå§‹åŒ– ======
    const map = L.map('map', { worldCopyJump: true, zoomControl: true }).setView([22, 110], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ====== 2) å½“å‰äººå‘˜-åæ ‡æ•°æ®ï¼ˆç‹¬ç«‹äººç‰©ï¼‰ ======
    // æ³¨ï¼šæ·±åœ³åæ ‡ 22.5431, 114.0579ï¼›å¹¿å· 23.1291, 113.2644ï¼›åŒ—äº¬ 39.9042, 116.4074
    const people = {
      'ç‰æ´':   [23.1291, 113.2644], // å¹¿å·
      'ä½³å¦®':   [23.1291, 113.2644], // å¹¿å·
      'åšéºŸ':   [23.1291, 113.2644], // å¹¿å·
      'åŒ…åŒ…':   [39.9042, 116.4074], // åŒ—äº¬
      'qq':     [38.9072, -77.0369], // åç››é¡¿ç‰¹åŒº
      'ç´«æ™´':   [35.0116, 135.7681], // äº¬éƒ½
      'å°çŒª':   [29.3503, 105.4417], // æ³¸å·ï¼ˆè™šçº¿åˆ°åŒ—ç–†ï¼‰
      'å¿—ç¦':   [23.3411, 114.1791], // ç½—æµ®å±±
      'nana':   [39.4699, -0.3763],  // è¥¿ç­ç‰™(ç“¦ä¼¦è¥¿äºš)
      'cx':     [22.5431, 114.0579], // æ·±åœ³
      'å›è™¹':   [22.5431, 114.0579], // æ·±åœ³
      'å˜‰æ€¡':   [22.5431, 114.0579], // æ·±åœ³
      'å½¬ç‚«':   [22.7783, 115.3653], // æ±•å°¾
      'æ‚¦æ‚¦':   [22.2705, 113.5767], // ç æµ·
      'ç‘¾å®':   [31.2304, 121.4737]  // ä¸Šæµ·
    };

    // ä¸€ä¸ªå®¹å™¨ä¿å­˜å½“å‰æ¸²æŸ“çš„ markerï¼ˆæŒ‰ groupKey å­˜ï¼‰
    let groupLayer = L.layerGroup().addTo(map);

    // ====== 3) å·¥å…·å‡½æ•°ï¼šåˆå¹¶åŒåœ°ç‚¹ï¼ˆå¸¦å®¹å·®ï¼‰ ======
    // å®¹å·®ï¼šå°æ•°ç‚¹å 3 ä½ï¼ˆ~100m-200m é‡çº§ï¼‰ï¼Œé¿å…åŒåŸç»†å¾®å·®å¼‚å¯¼è‡´å¤šä¸ªé’ˆ
    const PRECISION = 3;
    function keyFor([lat, lng]) { return lat.toFixed(PRECISION) + ',' + lng.toFixed(PRECISION); }

    function groupPeopleByLocation(dataObj) {
      const groups = new Map(); // key -> { coords:[lat,lng], names:[name,...] }
      for (const [name, coords] of Object.entries(dataObj)) {
        const k = keyFor(coords);
        if (!groups.has(k)) groups.set(k, { coords: coords.slice(0), names: [] });
        groups.get(k).names.push(name);
      }
      return groups;
    }

    // ====== 4) æ¸²æŸ“å‡½æ•°ï¼šæŒ‰åˆ†ç»„åªç”» 1 ä¸ªé’ˆï¼Œæ ‡ç­¾å±•ç¤ºæ‰€æœ‰åå­— ======
    function makeDivIcon(names) {
      const labelsHtml = names.map(n => `<span class="chip">${n}</span>`).join('');
      const html = `<div class="pin-wrapper"><span class="pin-emoji">ğŸ“Œ</span><span class="labels">${labelsHtml}</span></div>`;
      return L.divIcon({ html, className: '', iconSize: [0,0], iconAnchor: [12,22] });
    }

    function renderMarkers() {
      groupLayer.clearLayers();
      const groups = groupPeopleByLocation(people);
      groups.forEach(({coords, names}) => {
        const marker = L.marker(coords, { icon: makeDivIcon(names) }).addTo(groupLayer);
        marker.bindPopup(names.join('ã€'));
      });

      // è‡ªé€‚åº”è§†é‡ï¼ˆåŒ…å«æ‰€æœ‰åˆ†ç»„ç‚¹ï¼‰
      const bounds = L.latLngBounds([]);
      groups.forEach(({coords}) => bounds.extend(coords));
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.3));
    }

    // åˆæ¬¡æ¸²æŸ“
    renderMarkers();

    // ====== 5) å°çŒªè¿ç§»è·¯çº¿ï¼ˆæ³¸å· -> åŒ—ç–†ç¤ºä¾‹ï¼šä¹Œé²æœ¨é½ï¼‰ ======
    L.polyline([[29.3503, 105.4417], [43.8175, 87.6083]], { dashArray: '5,5', color: 'gray' }).addTo(map);

    // ====== 6) äº¤äº’ï¼šé€‰æ‹©åå­— + è¾“å…¥åœ°ç‚¹ï¼Œè¿›è¡Œåœ°ç†ç¼–ç åæ›´æ–° ======
    // ä¸‹æ‹‰äººå
    const selectEl = document.getElementById('person-select');
    Object.keys(people).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name; selectEl.appendChild(opt);
    });

    // ç®€å•åœ°ç†ç¼–ç ï¼ˆNominatimï¼‰ã€‚ç”Ÿäº§ç¯å¢ƒè¯·æ³¨æ„é€Ÿç‡é™åˆ¶ä¸ User-Agent è§„èŒƒã€‚
    function geocode(place) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
      return fetch(url, { headers: { 'Accept-Language': 'zh-CN' }})
        .then(r => r.json())
        .then(rows => {
          if (!rows || !rows.length) throw new Error('æœªæ‰¾åˆ°è¯¥åœ°ç‚¹');
          return [parseFloat(rows[0].lat), parseFloat(rows[0].lon)];
        });
    }

    document.getElementById('update-btn').addEventListener('click', () => {
      const name = selectEl.value;
      const place = document.getElementById('place-input').value.trim();
      if (!name) return alert('è¯·é€‰æ‹©åå­—');
      if (!place) return alert('è¯·è¾“å…¥åœ°ç‚¹');

      geocode(place).then(coords => {
        // æ›´æ–°è¯¥äººçš„åæ ‡
        people[name] = coords;
        // é‡æ–°åˆ†ç»„å¹¶æ¸²æŸ“ï¼ˆè‡ªåŠ¨åˆå¹¶/æ‹†åˆ†åŒåœ°ç‚¹é’ˆï¼‰
        renderMarkers();
        // èšç„¦
        map.setView(coords, 10);
      }).catch(err => alert(err.message || 'å®šä½å¤±è´¥'));
    });
  </script>
</body>
</html>
